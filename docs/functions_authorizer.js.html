<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: functions/authorizer.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: functions/authorizer.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * lambda function relating to manage the authorisation using different functions to Allow/Deny and
 * generate policy
 */
const Db = require('../helpers/db')
const Services = require('../helpers/services')

/**
 * handler to allow/deny the access to the ReST resource base on the authorization
 * @param event
 * @returns policy
 */
module.exports.handler = async (event) => {
  const accountKey = event.headers['x-api-key']

  if (!accountKey) {
    console.log('[401] Unauthorised: missing credentials')
    return generateDeny('me', event.methodArn)
  }

  const db = new Db()
  const services = new Services(db)
  const { rows } = await services.getApiKey(accountKey)

  const auth = rows[0]

  if (auth) {
    // if the end point is messageprocess then they need write access otherwise read access is needed
    if (!(auth.read || auth.write)) {
      console.log('[403] Forbidden')
      return generateDeny('me', event.methodArn)
    }
    switch (event.resource) {
      // These resources require write permissions
      case '/message':
      case '/activate-target-area':
      case '/deactivate-target-area':
        if (auth.write) {
          return generateAllow('me', event.methodArn)
        } else {
          console.log('[403] Forbidden')
          return generateDeny('me', event.methodArn)
        }
      // Historical and target areas require read and write as they're only to be used by the FWIS management console
      case '/historical-messages/{code}':
      case '/target-areas.json':
        if (auth.write &amp;&amp; auth.read) {
          return generateAllow('me', event.methodArn)
        } else {
          console.log('[403] Forbidden')
          return generateDeny('me', event.methodArn)
        }
      default:
        // Other wise read permission is required
        if (auth.read) {
          return generateAllow('me', event.methodArn)
        } else {
          console.log('[403] Forbidden')
          return generateDeny('me', event.methodArn)
        }
    }
  } else {
    console.log('[401] Unauthorised: not found')
    return generateDeny('me', event.methodArn)
  }
}

/**
 * function to generate policy using policyDocument template and passed in parameters
 * @param principalId
 * @param effect
 * @param resource
 * @returns generated policy
 */
// Help function to generate an IAM policy
const generatePolicy = function (principalId, effect, resource) {
  // Required output:
  return {
    principalId: principalId,
    policyDocument: {
      Version: '2012-10-17', // default version
      Statement: [
        {
          Action: 'execute-api:Invoke', // default action
          Effect: effect,
          Resource: resource
        }
      ]
    }
  }
}

/**
 * function to allow access
 * @param principalId
 * @param resource
 * @returns generated allow policy
 */
const generateAllow = function (principalId, resource) {
  return generatePolicy(principalId, 'Allow', resource)
}

/**
 * function to deny access
 * @param principalId
 * @param resource
 * @returns generated deny policy
 */
const generateDeny = function (principalId, resource) {
  return generatePolicy(principalId, 'Deny', resource)
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="global.html#Db">Db</a></li><li><a href="fwis.html">fwis</a></li><li><a href="Message.html">Message</a></li><li><a href="Services.html">Services</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AWS">AWS</a></li><li><a href="global.html#generateAllow">generateAllow</a></li><li><a href="global.html#generateDeny">generateDeny</a></li><li><a href="global.html#generatePolicy">generatePolicy</a></li><li><a href="global.html#handler">handler</a></li><li><a href="global.html#Joi">Joi</a></li><li><a href="global.html#queries">queries</a></li><li><a href="global.html#xml2js">xml2js</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Thu Feb 20 2020 15:13:02 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
